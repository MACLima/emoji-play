<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <title>Emoji Play</title>
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" href="/icons/icon-192.png" />
  <style>
    :root{
      --bg:#0b1020; --panel:#131a2c; --txt:#e7eefc; --muted:#9ab; --accent:#59f;
      --btn:#2a365a; --btn2:#1e293b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f22 60%);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin-inline:auto;padding:16px;display:flex;flex-direction:column;gap:16px}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between}
    h1{font-size:22px;margin:0;letter-spacing:.2px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{background:var(--btn);border:1px solid #31406b;color:var(--txt);padding:8px 12px;border-radius:10px;cursor:pointer}
    .tab[aria-selected="true"]{background:var(--accent);border-color:transparent;color:#021}
    .panel{background:rgba(19,26,44,.6);backdrop-filter:saturate(120%) blur(10px);border:1px solid #223158;padding:14px;border-radius:14px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    select,button{background:var(--btn2);border:1px solid #2f3f66;color:var(--txt);padding:8px 10px;border-radius:10px}
    button:hover{filter:brightness(1.1)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(70px,1fr));gap:10px}
    .emoji-btn{font-size:28px;background:#111a2b;border:1px solid #223158;border-radius:12px;padding:12px;display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer}
    .emoji-btn span{font-size:12px;color:var(--muted)}
    .marquee{display:flex;gap:12px;overflow:auto;scrollbar-width:thin;padding:6px;border-radius:12px;background:#0f162a;border:1px solid #223158}
    .story-slots{display:grid;grid-template-columns:repeat(4,minmax(60px,1fr));gap:8px;margin-top:8px}
    .slot{height:64px;display:flex;align-items:center;justify-content:center;font-size:32px;background:#111a2b;border:1px dashed #325; border-radius:12px;cursor:pointer}
    .banner{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.3);display:flex;gap:10px;align-items:center;z-index:9999}
    .hidden{display:none !important}
    footer{opacity:.6;text-align:center;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Emoji Play</h1>
      <nav class="tabs" role="tablist" aria-label="Modos">
        <button class="tab" role="tab" id="tab-galeria" aria-controls="panel-galeria" aria-selected="true">Galeria</button>
        <button class="tab" role="tab" id="tab-desfile" aria-controls="panel-desfile" aria-selected="false">Desfile</button>
        <button class="tab" role="tab" id="tab-historia" aria-controls="panel-historia" aria-selected="false">Hist√≥ria</button>
      </nav>
    </header>

    <!-- Galeria -->
    <section class="panel" role="tabpanel" id="panel-galeria" aria-labelledby="tab-galeria">
      <div class="controls">
        <label>Categoria:
          <select id="catSelect"></select>
        </label>
        <button id="speakAll">Falar todos</button>
      </div>
      <div id="grid" class="grid" aria-live="polite"></div>
    </section>

    <!-- Desfile -->
    <section class="panel hidden" role="tabpanel" id="panel-desfile" aria-labelledby="tab-desfile">
      <div class="controls">
        <label>Categoria:
          <select id="catMarquee"></select>
        </label>
        <label>Velocidade:
          <select id="speed">
            <option value="800">Lento</option>
            <option value="450" selected>M√©dio</option>
            <option value="250">R√°pido</option>
          </select>
        </label>
      </div>
      <div id="marquee" class="marquee" aria-live="polite"></div>
    </section>

    <!-- Hist√≥ria -->
    <section class="panel hidden" role="tabpanel" id="panel-historia" aria-labelledby="tab-historia">
      <div class="controls">
        <label>Categoria:
          <select id="catStory"></select>
        </label>
        <button id="tell">Contar hist√≥ria</button>
      </div>
      <div class="story-slots" id="slots"></div>
      <p id="storyText" style="margin-top:10px;color:var(--muted)"></p>
    </section>

    <footer>Funciona offline. Toque nos emojis para ouvir o nome.</footer>
  </div>

  <script>
  // =======================
  //  DADOS (exemplo)
  // =======================
  // Substitua por seu DATA real, se j√° tiver.
  const DATA = {
    "Carinhas": [
      ["üòÄ","rosto sorridente"],
      ["üòÅ","sorriso largo"],
      ["üòÇ","rindo muito"],
      ["üòä","sorriso t√≠mido"],
      ["üòé","descolado"]
    ],
    "Animais": [
      ["üê∂","cachorro"],
      ["üê±","gato"],
      ["üêµ","macaco"],
      ["ü¶ä","raposa"],
      ["üêº","panda"]
    ],
    "Comidas": [
      ["üçé","ma√ß√£"],
      ["üçå","banana"],
      ["üçï","pizza"],
      ["üç´","chocolate"],
      ["üç¶","sorvete"]
    ]
  };

  // =======================
  //  TABS (UI)
  // =======================
  const tabBtns = Array.from(document.querySelectorAll('.tab'));
  const panels = {
    'tab-galeria': document.getElementById('panel-galeria'),
    'tab-desfile': document.getElementById('panel-desfile'),
    'tab-historia': document.getElementById('panel-historia')
  };
  tabBtns.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      tabBtns.forEach(b=>b.setAttribute('aria-selected', b===btn ? 'true' : 'false'));
      Object.values(panels).forEach(p=>p.classList.add('hidden'));
      panels[btn.id].classList.remove('hidden');
    });
  });

  // =======================
  //  TTS (desbloqueio + vozes + speak)
  // =======================
  let ttsReady = false;
  function primeTTS(){
    if (ttsReady) return;
    try{
      const u = new SpeechSynthesisUtterance('');
      u.volume = 0;
      speechSynthesis.speak(u);
    }catch(e){}
    ttsReady = true;
  }
  window.addEventListener('touchstart', primeTTS, { once:true });
  window.addEventListener('click',      primeTTS, { once:true });

  let VOICES = [];
  function refreshVoices(){ VOICES = speechSynthesis.getVoices(); }
  speechSynthesis.addEventListener('voiceschanged', refreshVoices);
  refreshVoices();

  function speak(text, opts = {}){
    if (!text) return;
    if (!ttsReady) primeTTS();

    const u = new SpeechSynthesisUtterance(text);
    u.lang = opts.lang || 'pt-BR';
    u.rate = opts.rate ?? 1;
    u.pitch = opts.pitch ?? 1;

    const br = VOICES.find(v => v.lang?.toLowerCase().startsWith('pt-br'));
    if (br) u.voice = br;

    speechSynthesis.speak(u);
  }

  // =======================
  //  ELEMENTOS
  // =======================
  const catSelect  = document.getElementById('catSelect');
  const catMarquee = document.getElementById('catMarquee');
  const catStory   = document.getElementById('catStory');
  const grid       = document.getElementById('grid');
  const marquee    = document.getElementById('marquee');
  const speedSel   = document.getElementById('speed');
  const tellBtn    = document.getElementById('tell');
  const storyText  = document.getElementById('storyText');
  const slotsWrap  = document.getElementById('slots');
  const speakAll   = document.getElementById('speakAll');

  // =======================
  //  HELPERS DE RENDER
  // =======================
  function fillCategories(){
    const cats = Object.keys(DATA);
    [catSelect, catMarquee, catStory].forEach(sel=>{
      sel.innerHTML = '';
      for(const c of cats){
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = c;
        sel.appendChild(opt);
      }
    });
  }

  function renderGrid(){
    const cat = catSelect.value;
    const list = DATA[cat] || [];
    grid.innerHTML = '';
    for(const [emoji, label] of list){
      const b = document.createElement('button');
      b.className = 'emoji-btn';
      b.setAttribute('aria-label', label);
      b.innerHTML = `<div style="font-size:34px">${emoji}</div><span>${label}</span>`;
      b.addEventListener('click', ()=> speak(label));
      grid.appendChild(b);
    }
  }

  function renderMarquee(){
    const cat = catMarquee.value;
    const list = DATA[cat] || [];
    marquee.innerHTML = '';
    for(const [emoji, label] of list){
      const b = document.createElement('button');
      b.className = 'emoji-btn';
      b.style.minWidth = '90px';
      b.innerHTML = `<div style="font-size:34px">${emoji}</div><span>${label}</span>`;
      b.addEventListener('click', ()=> speak(label));
      marquee.appendChild(b);
    }
  }

  function renderPicker(){
    const cat = catStory.value;
    const list = DATA[cat] || [];
    slotsWrap.innerHTML = '';
    for(let i=0;i<4;i++){
      const s = document.createElement('button');
      s.className = 'slot'; s.textContent = '‚ûï';
      s.title = 'Escolher emoji';
      s.addEventListener('click', ()=>{
        // simples: alterna entre emojis da categoria
        const item = list[(Date.now()+i)%Math.max(1,list.length)];
        s.textContent = item ? item[0] : '‚ûï';
        s.dataset.label = item ? item[1] : '';
        speak(item ? item[1] : 'vazio');
      });
      slotsWrap.appendChild(s);
    }
    storyText.textContent = '';
  }

  // =======================
  //  EVENTOS (selects + bot√µes)
  // =======================
  catSelect .addEventListener('change', renderGrid);
  catMarquee.addEventListener('change', renderMarquee);
  catStory  .addEventListener('change', renderPicker);

  speakAll.addEventListener('click', ()=>{
    const cat = catSelect.value;
    const list = DATA[cat] || [];
    // fala cada item com pequeno intervalo
    let i=0;
    const step=()=>{
      if(i>=list.length) return;
      speak(list[i][1]);
      i++; setTimeout(step, 550);
    };
    step();
  });

  tellBtn.addEventListener('click', ()=>{
    const chosen = Array.from(slotsWrap.children).map(s=>[s.textContent, s.dataset.label||''].map(v=>v||''));
    const labels = chosen.map(([,lbl])=>lbl).filter(Boolean);
    if(!labels.length){ storyText.textContent = 'Escolha alguns emojis para criar a hist√≥ria.'; return; }
    const sentence = makeSentence(labels);
    storyText.textContent = sentence;
    speak(sentence, { rate: 1 });
  });

  function makeSentence(labels){
    // modelo bem simples; personalize √† vontade
    if(labels.length===1) return `${labels[0]}!`;
    if(labels.length===2) return `${labels[0]} e ${labels[1]}!`;
    return `${labels.slice(0,-1).join(', ')} e ${labels.at(-1)}!`;
  }

  // =======================
  //  INIT
  // =======================
  function init(){
    fillCategories();
    // Seleciona primeira categoria por padr√£o
    [catSelect,catMarquee,catStory].forEach(sel=>{
      if(sel.options.length) sel.selectedIndex = 0;
    });
    renderGrid();
    renderMarquee();
    renderPicker();
  }

  // =======================
  //  SW + Banner de atualiza√ß√£o
  // =======================
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js');

    // Banner de ‚ÄúNova vers√£o dispon√≠vel‚Äù
    navigator.serviceWorker.getRegistration().then(reg=>{
      if(!reg) return;
      reg.addEventListener('updatefound', ()=>{
        const nw = reg.installing;
        nw.addEventListener('statechange', ()=>{
          if(nw.state==='installed' && navigator.serviceWorker.controller){
            showUpdateBanner(()=> nw.postMessage({ type:'SKIP_WAITING' }));
          }
        });
      });
    });

    // Recarrega quando o SW novo assume o controle
    navigator.serviceWorker.addEventListener('controllerchange', ()=> location.reload());
  }

  function showUpdateBanner(onClick){
    const b = document.createElement('div'); b.className='banner';
    b.innerHTML = `<span>üîÑ Nova vers√£o dispon√≠vel</span>
      <button style="background:#2563eb;border:0;color:#fff;padding:6px 12px;border-radius:8px;font-weight:600;cursor:pointer">Atualizar</button>`;
    b.querySelector('button').onclick = ()=>{ b.remove(); onClick(); };
    document.body.appendChild(b);
  }

  // Start
  init();
  </script>
</body>
</html>
